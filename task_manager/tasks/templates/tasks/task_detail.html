<!-- task_manager/tasks/templates/tasks/task_detail.html -->

{% extends "base.html" %}

{% block title %}{{ task.title }}{% endblock %}

{% block content %}
<section>
    <h1 class="mb-4">{{ task.title }}</h1>

    <article class="card">
        <div class="card-body">
            <p class="card-text">{{ task.description }}</p>

            <dl class="row">
                <dt class="col-sm-3">作成日</dt>
                <dd class="col-sm-9">{{ task.created_at|date:"Y-m-d H:i" }}</dd>

                <dt class="col-sm-3">更新日</dt>
                <dd class="col-sm-9">{{ task.updated_at|date:"Y-m-d H:i" }}</dd>

                <dt class="col-sm-3">状態</dt>
                <dd class="col-sm-9">
                    {% if task.is_completed %}
                        <span class="badge bg-secondary">完了</span>
                    {% else %}
                        <span class="badge bg-light text-dark border">未完了</span>
                    {% endif %}
                </dd>

                {% if task.completed_comment %}
                    <dt class="col-sm-3">完了コメント</dt>
                    <dd class="col-sm-9">{{ task.completed_comment }}</dd>
                {% endif %}

                <dt class="col-sm-3">アーカイブ</dt>
                <dd class="col-sm-9">{{ task.is_archived|yesno:"済,-" }}</dd>
            </dl>

            {% if subtasks %}
            <hr>
            <h3>子タスク一覧</h3>
            <ul class="list-group mb-3">
                {% for subtask in subtasks %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{% url 'tasks:task_detail' subtask.pk %}">{{ subtask.title }}</a>
                        {% if subtask.is_completed %}
                            <span class="badge bg-secondary">完了</span>
                        {% else %}
                            <span class="badge bg-light text-dark border">未完了</span>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">子タスクはありません。</p>
            {% endif %}

            <hr>
            <h3>操作</h3>
            <nav class="mt-3">
                <a href="{% url 'tasks:task_update' task.pk %}" class="btn btn-outline-primary">編集</a>
                <a href="{% url 'tasks:task_delete' task.pk %}" class="btn btn-outline-danger">削除</a>
                <a href="{% url 'tasks:task_create_child' task.pk %}" class="btn btn-outline-primary">子タスクを追加</a>

                {% if task.parent %}
                <a href="{% url 'tasks:task_detail' task.parent.pk %}" class="btn btn-outline-secondary">
                    親タスクへ戻る: {{ task.parent.title }}
                </a>
                {% endif %}

                <a href="{% url 'tasks:task_list' %}" class="btn btn-outline-secondary">一覧へ戻る</a>

                {% if not task.is_completed %}
                    {% if has_incomplete_subtasks %}
                        <button class="btn btn-success" disabled>完了にする</button>
                        <span class="text-warning ms-2">※子タスクが未完了のため完了できません</span>
                    {% else %}
                        <form method="post" action="{% url 'tasks:task_complete' task.pk %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success">完了にする</button>
                        </form>
                    {% endif %}
                {% endif %}

            </nav>
        </div>
    </article>
</section>
{% endblock %}
